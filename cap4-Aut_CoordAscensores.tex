% ---------------------------------------------------------------------------------------
\chapter{Automatización coordinada de dos ascensores prototipos}\label{chap4}
\section{Requerimientos funcionales}\label{ReqFuncionales2asc}
Los requerimientos funcionales enumerados a continuación son los utilizados para crear un diagrama secuencial que permita la automatización del sistema, en este proyecto la automatización coordinada de dos ascensores prototipos. Estos requerimientos permitirán que el movimiento de la cabina sea el óptimo en recorrido y asegurar un buen servicio al usuario futuro.\\

Los requerimientos son los siguientes:
\begin{itemize}
\item \textbf{Solicitudes y recorridos:}
\begin{enumerate}
\item La consola externa de los dos ascensores deben estar comunicadas para que se encienda una única solicitud por piso a pesar de tener dos pulsadores, uno en cada ascensor. Por ejemplo:
\begin{enumerate}
\item Si se presiona el pulsador externo del tercer piso se encenderán los LED's indicadores del tercer piso de ambos ascensores señalando que la solicitud fue aceptada y que no es necesario presionar el pulsador en cada ascensor.
\end{enumerate}
\item La consola interna de cada ascensor es independiente para cada uno, haciendo que cada solicitud hecha por consola interna será satisfecha por el ascensor correspondiente.
\item El ascensor más cercano a la solicitud es el que va a atenderla.
\item Se debe crear un sistema maestro/esclavo entre ambos ascensores para que el ascensor maestro tenga prioridad de cumplir solicitudes si es que ambos están libres de cumplir la solicitud. Por ejemplo:
\begin{enumerate}
\item Si ambos ascensores están detenidos en el primer piso y llega una solicitud del tercer piso, el ascensor maestro será el que cumplirá esta solicitud para evitar que ambos vayan al mismo llamado.
\end{enumerate}
\item El ascensor atenderá la solicitud desde la consola externa si y solo si la solicitud concuerda con el movimiento que hará o hace. Por ejemplo:
\begin{enumerate}
\item Si un ascensor está en el primer piso y se dirige al tercer piso, este puede atender la solicitud de subir del segundo piso y detenerse, pero no si se solicita bajar desde el segundo piso.
\end{enumerate}
\item El ascensor maestro ignora una solicitud, el ascensor esclavo tiene que atenderla. Por ejemplo:
\begin{enumerate}
\item Si el ascensor maestro se dirige al tercer piso y se solicita bajar desde el segundo piso, el ascensor esclavo tiene que ir a atenderla.
\end{enumerate}
\item Cuando una cabina llegue al piso correspondiente debe detenerse un tiempo para simular que el usuario suba o baje de ella.
\item La luz interna de la cabina debe encenderse a partir de cada solicitud que vaya a atender y apagarse después de un tiempo de inactividad.
\end{enumerate}  
\item \textbf{Comunicación:}
\begin{enumerate}
\item En caso de perderse la comunicación entre ambos ascensores, cada uno debe funcionar de manera independiente.
\end{enumerate}
\end{itemize}

\section{Red de PLC's S7-200}
Debido a las limitantes de entradas digitales y salidas digitales con las que cuenta el PLC S7-200 se necesitará utilizar dos PLC's S7-200 para poder automatizar el sistema de dos ascensores, donde cada PLC cuenta con su propio ascensor prototipo. \\

Por lo tanto, para hacer la automatización coordinada de ambos ascensores se necesitará crear una red de comunicación entre ambos PLC, para ello se utilizará un cable bifilar trenzado y apantallado con un terminal Profibus resistivo con conector RS485 en cada extremo para armar una red Profibus donde ambos PLC's se comunicaran entre si usando protocolo PPI, esta red permitirá que ambos PLC's mantengan un intercambio de variables entre ellos para compartir estados y así poder coordinar y optimizar sus recorridos. Además un PLC, el que será usado como PLC maestro, tiene el módulo de comunicación Ethernet CP243-1 IT, el cual será utilizado para comunicarse con el computador a través de la red del departamento y así crear un HMI que permita supervisar el funcionamiento y estado de ambos ascensores, mientras se mantenga la comunicación.\\

Para cumplir todo lo anteriormente detallado se creo una red de comunicación que queda detallada en la figura \ref{RedPLC} donde se ve la arquitectura de control y supervisión del sistema.

\begin{landscape}
\begin{figure}[t]
\centering
\includegraphics[scale=0.4]{fig/Arquitectura2ascensores.png}
\caption{Arquitectura de control y supervisión.}
\label{RedPLC}
\end{figure}
\end{landscape}


\subsection{Configuración NETR/NETW}\label{netrnetw}
Para poder generar la comunicación PPI entre ambos PLC's se debe utilizar el asistente NETR/NETW contenido en el software STEP7 MicroWIN que permite crear una comunicación entre ambos PLC's enviando solicitudes de lectura y escritura al otro PLC, donde NETR la función que genera las solicitudes de lectura y NETW, las solicitudes de escritura. \\

La comunicación se genera de la siguiente forma:

\begin{enumerate}
\item Buscar en la barra lateral con las carpetas de funciones del software la carpeta ``Asistentes'' y dentro de ella la función ``NETR/NETW'', donde se abrirá el cuadro de diálogo del asistente NETR/NETW y dentro de este poder elegir la cantidad de funciones a programar que en este proyecto son dos, una función en que se generan solicitudes de lectura, subrutina ``NETR'', y otra función que genera solicitudes de escritura, subrutina ``NETW'', véase figura \ref{Asisnetrw1}.

\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{fig/NETRW1.png}
\caption{Primer cuadro del asistente de configuración ``NETR/NETW''.}
\label{Asisnetrw1}
\end{figure}

\item En el siguiente cuadro se elige el puerto del CPU donde se harán las operaciones que es el puerto ``0'', además se genera el nombre ``NET\_EXE'' para la subrutina por defecto el cual puede ser modificado, véase   la figura

\begin{figure}[H]
\centering
\includegraphics[scale=0.7]{fig/NETRW2.png}
\caption{Puerto del CPU y nombre de la subrutina.}
\label{Asisnetrw2}
\end{figure}

\item En el siguiente cuadro se configuran las operaciones que harán las dos funciones, en este caso una función será ``NETR'' y la otra ``NETW''; también se debe elegir la dirección del PLC que será leído o escrito, la dirección del PLC esclavo en esta red tiene la dirección 4; además se debe elegir la cantidad de bytes utilizados en cada operación, en este proyecto se utilizarán 3 bytes para tener holgura de bites; en la selección de los bytes para cada operación hay que ser cauteloso para no elegir bytes que se repitan y haya futuros errores, se elije desde VB0 a VB2 para la operación de lectura y desde VB3 a VB5 para escritura, véase figura \ref{Asisnetrw3} y \ref{Asisnetrw4}.

\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{fig/NETRW3.png}
\caption{Configurar operación NETR y bytes de lectura.}
\label{Asisnetrw3}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{fig/NETRW4.png}
\caption{Configurar operación NETW y bytes de escritura.}
\label{Asisnetrw4}
\end{figure}

\item Por último se debe elegir los bytes de memoria que serán utilizados para guardar la configuración, esta función en particular necesita 23 bytes de memoria por dos operaciones para ser guardadas, el cuadro te permite proponer una dirección o puede ser elegida manualmente, si se hace de manera manual hay que tener cuidado con no usar bytes de memoria que hayan sido utilizados antes, en el último cuadro se señala que se creará una subrutina ``NET\_EXE'' y además una pestaña ``NET\_SYMS'' en la tabla de símbolos, véase figura \ref{Asisnetrw5}.

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{fig/NETRW5.png}
\caption{Asignación de memoria para guardar configuración ``NETR/NETW''.}
\label{Asisnetrw5}
\end{figure}
\end{enumerate}

Después de finalizado el asistente ``NETR/NETW'' se debe agregar el bloque de subrutina ``NET\_EXE'' en el diagrama LADDER para permitir el envío de solicitudes al PLC esclavo, por lo tanto se utilizará el bloque ``NET\_EXE'' en el Network 1 energizado por el bit especial ``SM0.0'' que es un bit especial que siempre está encendido para que se envíe siempre solicitudes, además se agregan dos bit de memorias para guardar los ciclos de la subrutina y otro bit para el error, que es uno si hay algún error de comunicación, véase \ref{NETEXE}.

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{fig/NET_EXE.png}
\caption{Network del LADDER donde se usa la subrutina.}
\label{NETEXE}
\end{figure}

Además se configuraron seis bloques de trasferencia ``MOV'' para tomar las variables leídas y guardarlas para su uso en el PLC y tomar las variables del PLC y moverlas a las variables de escritura; las variables transferidas de lecturas están agregadas a continuación de la subrutina ``NET\_EXE'' para contar con ellas en todo el código (Network 2, 3 y 4) y las variables transferidas para escritura están agregadas al final del código (Network 41, 42 y 43), véase \ref{NETMB}.

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{fig/NET_MB.png}
\caption{Transferencia de memorias para lectura y escritura.}
\label{NETMB}
\end{figure}

Esta configuración tiene que ser cargada en el PLC y se tiene que reiniciar el PLC con ``reset al iniciar'' en el menú CPU en la barra superior, véase figura \ref{Reset}.

\section{Programación S7-Graph}
Para crear la secuencia que automatizará ambos ascensores se utilizó GRAFCET, debido a que se usarán dos PLC's para desarrollar este proyecto se debe crear una secuencia por separado para cada ascensor prototipo y cargarlo en su respectivo PLC; siguiendo como base la secuencia utilizada para un ascensor prototipo (véase en sección \ref{hmi1asc}).\\

La secuencia del ascensor maestro cuenta con 4 estados (S0, S1, S2 y S3) y de 4 transiciones compuestas por condiciones de sensores y pulsadores de ambos ascensores y del estado del ascensor esclavo, como se puede ver en la figura \ref{GrafcetLocal}.\\

La secuencia del ascensor esclavo cuenta con 4 estados y de 4 transiciones compuestas al igual que la secuencia del ascensor maestro donde las diferencias recaen en las transiciones ya que muchas variables dependen del otro ascensor, como se puede ver en la figura \ref{GrafcetRemoto}.\\

Los estados S0, S1, S2 y S3 son iguales para ambos ascensores; donde S0 es el estado de inicialización del sistema, donde se realiza la puesta en cero de todos los estados ante cualquier reinicio general y asegurar que la secuencia empiece desde S1.Por otro lado, se estado S1, S2 y S3 son estados de acción los cuales hacen que el ascensor se detenga si se activa S1, que suba si se activa S2 o que baje si está activo S3; además en S1 se activa el timer ON ``Timer\_wait'' que es el encargado de detenerse el ascensor en un piso antes de seguir su recorrido por eso la variable ``Wait\_on'' condiciona T1 y T3, en S2 y S3 se activa el timer OFF ``Timer\_LIC'' que es el encargado de mantener la luz de la cabina encendida durante el movimiento de la cabina y mantenerla durante un tiempo después de la inactividad.

\begin{landscape}
\begin{figure}[H]
\centering
\includegraphics[scale=0.45]{fig/2AscensorLOCAL.png}
\caption{GRAFCET para automatizar ascensor maestro.}
\label{GrafcetLocal}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}[H]
\centering
\includegraphics[scale=0.45]{fig/2AscensorREMOTO.png}
\caption{GRAFCET para automatizar ascensor esclavo.}
\label{GrafcetRemoto}
\end{figure}
\end{landscape}

Antes de empezar a explicar las transiciones de estos dos GRAFCET se necesita tener claridad sobre algunas variables que están consideradas y así entenderlos de mejor forma. Véase la tabla \ref{DefVariables}.

\begin{table}[H]
\centering
\begin{tabular}{|p{4.5cm}|p{9cm}|}
\hline
\multicolumn{1}{|c|}{\textbf{Variable}}&\multicolumn{1}{c|}{\textbf{Comentario}}\\ \hline
Bajar\_AscX & Bit indicador si ascensor X está bajando\\ \hline
Subir\_AscX & Bit indicador si ascensor X está subiendo\\ \hline
MSC1\_AscX & Memoria de sensor cabina en primer piso\\ \hline
MSC2\_AscX & Memoria de sensor cabina en segundo piso\\ \hline
MSC3\_AscX & Memoria de sensor cabina en tercer piso\\ \hline
PI1 & Pulsador consola interna ir a primer piso\\ \hline
PI2 & Pulsador consola interna ir a segundo piso\\ \hline
PI3 & Pulsador consola interna ir a tercer piso\\ \hline
PE1\_AscX & Pulsador consola externa subir desde primer piso\\ \hline
PE2B\_AscX & Pulsador consola externa bajar desde segundo piso\\ \hline
PE2S\_AscX & Pulsador consola externa subir desde segundo piso\\ \hline
PE3\_AscX & Pulsador consola externa bajar desde tercer piso\\ \hline
SC1\_AscX & Sensor cabina en primer piso del ascensor X\\ \hline
SC2\_AscX & Sensor cabina en segundo piso del ascensor X\\ \hline
SC3\_AscX & Sensor cabina en tercer piso del ascensor X\\ \hline
\end{tabular}
\textit{X: 1 (ascensor 1) y 2 (ascensor 2)}
\caption{Tabla de definiciones.}
\label{DefVariables}
\end{table}

Las transiciones T1 y T3 utilizadas en el GRAFCET del ascensor maestro tiene como primera condición ``Wait\_on'' que, como se explicó antes, hace que la cabina espere un tiempo en el piso donde se detiene antes de atender la siguiente solicitud; además como la consola interna es independiente a cada ascensor se puede ver que los pulsadores internos de la cabina permiten el paso de estado solamente si el tiempo de espera ya fue cumplido, a diferencia de las otras condiciones que dependen del comportamiento del ascensor esclavo para que se cumplan, esto también puede verse en el GRAFCET del ascensor esclavo.\\

Primero se explicaran las transiciones del GRAFCET maestro T1 y T3, se aprovechan que T3 es igual a T1 pero invertida. Las condiciones de T1 y T3 del ascensor maestro buscan priorizar su atención de solicitudes por encima del ascensor esclavo, por esto mismo cuando ambos ascensores se encuentran en el mismo piso el ascensor maestro puede atender cualquier solicitud que sea presionada a través de la consola externa, ahora bien si el ascensor esclavo está en el segundo piso pero se esta moviendo por alguna solicitud el ascensor maestro puede atender las solicitudes del segundo piso, si el ascensor maestro está en el segundo piso puede atender cualquier solicitud del tercer piso si el ascensor esclavo está en el primer piso y viceversa estando el esclavo en el tercer piso y se solicita bajar el primer piso. Por otro lado, las transiciones T2 y T4 son las transiciones que permiten salir de los estados de movimiento (S2 y S3) para detenerse en un piso (S1) por este motivo si la cabina activa un sensor de piso y existe una solicitud en ese piso, este tiene que detenerse para atenderla, a menos que la solicitud sea opuesta al movimiento que lleva la cabina por ejemplo cuando sube desde el primer piso por PE2b, el ascensor sólo se detiene si no tiene que ir al tercer piso antes y viceversa cuando baja.\\

Segundo y último se explicarán las transiciones del GRAFCET esclavo T1 y T3, que igual se explicará T3 y T1 a la vez ya que son iguales pero invertidas. Las condiciones de T1 y T3 del ascensor esclavo busca atender las solicitudes que el ascensor maestro debe ignorar,
por este motivo T1 y T3 no tiene condiciones en que coincidan ambos ascensores en el mismo piso, solamente atiende solicitudes cuando el ascensor esclavo esta más cerca que el ascensor maestro a alguna solicitud o si el ascensor esclavo esta atendiendo una solicitud e ignora algún otra. Por otra parte, las transiciones T2 y T4 son condiciones que hacen que la cabina del ascensor se detenga (salir de S2 o S3 y entrar a S1) para eso se relaciona el sensor de piso que se activa junto al pulsador del piso que estaba presionada, al igual que T2 y T4 del GRAFCET del maestro.

\section{Supervisión mediante SCADA HMI vía Ethernet TCP/IP}
Para poder hacer un HMI para supervisión del sistema de dos ascensores prototipo vía Ethernet se necesita tener configurado el módulo de comunicación Ethernet del PLC S7-200 maestro (véase sección \ref{moduloEthernet}), el servidos OPC a través del software PC Access (véase sección \ref{OPCserver}) y por último el software SCADA iFix para armar un interfaz gráfico (véase sección \ref{SCADAiFix}).

Para verificar si estás configuraciones fueron aplicadas correctamente se verá la información del PLC, en específico del modulo de comunicación, para ver si las direcciones IP están correctas (ver figura \ref{Informacion2}), además se revisará si todos los ítemes del PLC están siendo leídos por el servidor OPC del PC Access (ver figura \ref{PCAccess}) y por último corroborar que todos los ítemes del OPC están enlazados con el SCADA iFix revisando el PowerTools y Database (ver figura \ref{OPC} y \ref{Database}) 

\begin{figure}[H]
\centering
\includegraphics[scale=0.6]{fig/Informacion2.png}
\caption{Verificando direcciones IP del módulo Ethernet.}
\label{Informacion2}
\end{figure}
 
\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{fig/PCACCESS2-2asc.png}
\caption{Estado de variables del servidor OPC.}
\label{PCAccess}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{fig/DATABASE.png}
\caption{Base de datos del SCADA iFix.}
\label{Database}
\end{figure}

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{fig/OPC.png}
\caption{Ítemes en OPC del SCADA iFix.}
\label{OPC}
\end{figure}

Después de verificar todo lo anterior, se armó el HMI para la supervisión del sistema de dos ascensores prototipos; en este HMI se puede apreciar el movimiento de los ascensores, el piso en el cual se encuentra, si alguno esta subiendo o bajando, los LED's indicadores de solicitudes tanto de la consola externa como de ambas consolas internas, además si las luces de la cabina están encendidas y, por último, también hay una luz que señala cuando hay un error de comunicación entre ambos PLC's, dando como resultado los que se puede ver en la figura \ref{HMI}.

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{fig/HMI.png}
\caption{HMI final hecho en iFix.}
\label{HMI}
\end{figure}

\section{Análisis de resultados}

Debido al conocimiento obtenido en la sección \ref{chap3} en esta parte del trabajo solamente se tuvo que aprender a utilizar la subrutina de las operaciones ``NETR/NETW'' que son las encargadas de generar la comunicación entre los PLC's a través de la comunicación PPI, pero la complejidad del GRAFCET para ambos ascensores fue alta debido a que ambos ascensores tenían su propio PLC y por ende su propio programa automatizador ya que las variables que se intercambian entre ellos son usadas constantemente y debían permitir el movimientos de ambos ascensores y de manera optima, a pesar de la complejidad de pudo crear un diagrama GRAFCET que permitiera el correcto funcionamiento coordinado de ambos ascensores.\\

A continuación se adjuntan capturas de pantalla del HMI funcionando y supervisando el funcionamiento de ambos ascensores, de la luz indicadora de la perdida de comunicación y la supervisión de un solo ascensor cuando se pierde la comunicación ya que los estados del ascensor esclavos no pueden ser leídos.\\

En la figura \ref{HMI2func1} se puede apreciar el funcionamiento de ambos ascensores, de las luces que indican las solicitudes a través de la consola externa o de las consolas internas, flecha indicadora de el comportamiento del ascensor, la luz de la cabina y por último, un tablero de ocho segmentos que muestra el piso en el que está el ascensor.

\begin{figure}[H]
\centering
\includegraphics[scale=0.4]{fig/HMI2FUNCIONANDO.png}
\caption{Supervisión HMI de ambos ascensores prototipo.}
\label{HMI2func1}
\end{figure}

Por otra parte, en la figura \ref{HMI2func2} se puede apreciar la luz indicadora de ``Error de comunicación'' que muestra cuando se pierde la comunicación entre ambos PLC's.

\begin{figure}[H]
\centering
\includegraphics[scale=0.4]{fig/HMI2FUNCIONANDO_ERROR2.png}
\caption{Supervisión HMI cuando se pierde la comunicación.}
\label{HMI2func2}
\end{figure}

Por último, se puede apreciar el funcionamiento de un ascensor que es el ascensor maestro aún cuando existe error de comunicación.

\begin{figure}[H]
\centering
\includegraphics[scale=0.4]{fig/HMI2FUNCIONANDO_ERROR.png}
\caption{Supervisión HMI de un ascensor funcionando y luz de error.}
\label{HMI2func}
\end{figure}